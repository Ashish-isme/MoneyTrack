@page "/transactions"
@using MudBlazor
@using MoneyTrack.Models
@using MoneyTrack.Services
@inject ITransactionService TransactionService
@inject AuthenticationStateService authStateService
@inject NavigationManager navigationManager
@inject TagService tagsService

<h3 class="text-center font-weight-bold pt-4" style="margin-top: 40px;">Transaction History Management</h3>

@if (!authStateService.IsAuthenticated())
{
    <p>You are not authenticated. Please log in first.</p>
    navigationManager.NavigateTo("/login");
}
else
{
    var currentUser = authStateService.GetAuthenticatedUser();

    <div>
        <h4>Welcome, @currentUser.User_Name</h4>
        <p style="color: cadetblue">Total Transactions: @totalTransactions.ToString("C")</p>
        <p style="color: cadetblue">Total Number of Transactions: @filteredTransactions.Count</p>
    </div>

    @if (filteredTransactions == null || filteredTransactions.Count == 0)
    {
        <MudAlert Severity="Severity.Warning" Variant="Variant.Filled" ContentAlignment="HorizontalAlignment.Center" ShowCloseIcon="true" CloseIconClicked="(() => CloseMe())" Visible="@alertVisible">
            No transactions found.
        </MudAlert>
    }

    <!-- Search Bar -->
    <div class="mb-3">
        <label for="search-title" class="form-label">Search by Title:</label>
        <div class="input-group">
            <input type="text" id="search-title" class="form-control" @bind="searchTitle" @oninput="OnSearchChanged" placeholder="Enter title to search..." />
        </div>
    </div>

    <!-- Filter and Search Options -->
    <div class="filter-container" style=" margin-top:40px;">
        <div class="filter-group">
            <label for="date-range">Filter by Date Range:</label>
            <input type="date" @bind="startDate" /> to
            <input type="date" @bind="endDate" />
            <button @onclick="FilterByDate" class="btn btn-outline-success btn-sm w-10 mt-3" style="margin-top: 15px;">Apply</button>
        </div>

        <div class="filter-group">
            <label for="tags-select">Filter by Type:</label>
            <select id="tags-select" @onchange="FilterByType" class="form-control">
                <option value="">Select a Type</option>
                <option value="Credit">Credit</option>
                <option value="Debit">Debit</option>
                <option value="Debt">Debt</option>
            </select>
        </div>

        <div class="filter-group">
            <label for="tag-select">Filter by Tag:</label>
            <select id="tag-select" @onchange="FilterByTag" class="form-control">
                <option value="">Select a Tag</option>
                @foreach (var tag in tags)
                {
                    <option value="@tag">@tag</option>
                }
            </select>
        </div>
    </div>

    <!-- Sorting Options -->
    <div class="sort-container">
        <button @onclick="SortByAmount" class="btn btn-link btn-sm">
            Amount
            @if (isAmountAscending)
            {
                <i class="fa fa-arrow-up"></i>
            }
            else
            {
                <i class="fa fa-arrow-down"></i>
            }
        </button>

        <button @onclick="SortByDate" class="btn btn-link btn-sm">
            Date
            @if (isDateAscending)
            {
                <i class="fa fa-arrow-up"></i>
            }
            else
            {
                <i class="fa fa-arrow-down"></i>
            }
        </button>
    </div>

    <!-- Table -->
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Title</th>
                <th>Amount</th>
                <th>Date</th>
                <th>Type</th>
                <th>Tags</th>
                <th>Remarks</th>
            </tr>
        </thead>

        <tbody>
            @if (filteredTransactions != null && filteredTransactions.Count > 0)
            {
                @foreach (var transaction in filteredTransactions)
                {
                    <tr>
                        <td>@transaction.transactiontitle</td>
                        <td>@transaction.transactionamount.ToString("C")</td>
                        <td>@transaction.transactiondate.ToShortDateString()</td>
                        <td>@transaction.transactiontype</td>
                        <td>@(string.IsNullOrWhiteSpace(transaction.transactiontags) ? "N/A" : transaction.transactiontags)</td>
                        <td>@(string.IsNullOrWhiteSpace(transaction.transactionremarks) ? "N/A" : transaction.transactionremarks)</td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="6" class="text-center">No transactions available to display.</td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<Transaction> userTransactions = new();
    private List<Transaction> filteredTransactions = new();
    private string selectedType = "";
    private string selectedTag = "";
    private DateTime startDate = DateTime.Today.AddMonths(-1);
    private DateTime endDate = DateTime.Today;
    private float totalTransactions = 0;
    private bool alertVisible = true;
    private List<string> tags = new();
    private string searchTitle = "";
    private bool isAmountAscending = true;
    private bool isDateAscending = true;

    protected override async Task OnInitializedAsync()
    {
        if (authStateService.IsAuthenticated())
        {
            await LoadTransactions();
            await LoadTags();
        }
        else
        {
            navigationManager.NavigateTo("/login");
        }
    }

    private async Task LoadTransactions()
    {
        var currentUser = authStateService.GetAuthenticatedUser();
        userTransactions = TransactionService.GetTransactionsByUserId(currentUser.UserId)
                                             .OrderByDescending(t => t.transactiondate)
                                             .ToList();

        filteredTransactions = new List<Transaction>(userTransactions);
        CalculateTotalTransactions();
    }

    private async Task LoadTags()
    {
        var currentUser = authStateService.GetAuthenticatedUser();
        tags = tagsService.GetCustomTags(currentUser.UserId);
    }

    private void SortByAmount()
    {
        if (isAmountAscending)
        {
            filteredTransactions = filteredTransactions.OrderByDescending(t => t.transactionamount).ToList();
        }
        else
        {
            filteredTransactions = filteredTransactions.OrderBy(t => t.transactionamount).ToList();
        }
        isAmountAscending = !isAmountAscending;
    }

    private void SortByDate()
    {
        if (isDateAscending)
        {
            filteredTransactions = filteredTransactions.OrderByDescending(t => t.transactiondate).ToList();
        }
        else
        {
            filteredTransactions = filteredTransactions.OrderBy(t => t.transactiondate).ToList();
        }
        isDateAscending = !isDateAscending;
    }

    private async Task FilterByDate()
    {
        var currentUser = authStateService.GetAuthenticatedUser();
        filteredTransactions = TransactionService.FilterTransactionsByDate(startDate, endDate)
                                                  .Where(t => t.UserId == currentUser.UserId)
                                                  .ToList();

        ApplyFilters();
        CalculateTotalTransactions();
    }

    private void FilterByType(ChangeEventArgs e)
    {
        selectedType = e.Value?.ToString();
        ApplyFilters();
    }

    private void FilterByTag(ChangeEventArgs e)
    {
        selectedTag = e.Value?.ToString();
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        var currentUser = authStateService.GetAuthenticatedUser();

        filteredTransactions = userTransactions.Where(t => t.UserId == currentUser.UserId)
                                                .Where(t => string.IsNullOrEmpty(selectedType) || t.transactiontype == selectedType)
                                                .Where(t => string.IsNullOrEmpty(selectedTag) || t.transactiontags.Contains(selectedTag))
                                                .Where(t => string.IsNullOrEmpty(searchTitle) || t.transactiontitle.Contains(searchTitle, StringComparison.OrdinalIgnoreCase))
                                                .ToList();

        CalculateTotalTransactions();
    }

    private void CalculateTotalTransactions()
    {
        totalTransactions = filteredTransactions
            .Where(t => t.transactiontype == "Credit")
            .Sum(t => t.transactionamount)
            + filteredTransactions
            .Where(t => t.transactiontype == "Debt")
            .Sum(t => t.transactionamount)
            - filteredTransactions
            .Where(t => t.transactiontype == "Debit")
            .Sum(t => t.transactionamount);
    }

    private async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Task.Delay(5000);
            CloseMe();
        }
    }

    private void CloseMe()
    {
        alertVisible = false;
        StateHasChanged();
        navigationManager.NavigateTo(navigationManager.Uri, true);
    }

    private void OnSearchChanged(ChangeEventArgs e)
    {
        searchTitle = e.Value?.ToString() ?? "";
        ApplyFilters();
    }
}

<style>
    .filter-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 20px;
    }

    .filter-group {
        flex: 1;
        min-width: 250px;
    }

        .filter-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }

    .sort-container {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-bottom: 20px;
    }

    .btn-outline-success {
        border-color: #6c757d;
        color: #6c757d;
        font-size: 0.7rem;
        padding: 4px 8px;
        background-color: white;
    }

        .btn-outline-success:hover {
            background-color: #28a745;
            color: white;
            border-color: #28a745;
        }
</style>
